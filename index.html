<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>자격루: 조선의 자동 시보 시스템</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Pretendard', sans-serif; }
        #ui-container {
            position: absolute; left: 40px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; align-items: center; z-index: 100;
        }
        #time-slider {
            -webkit-appearance: none; width: 10px; height: 450px; background: #222;
            outline: none; border-radius: 5px; appearance: slider-vertical; cursor: pointer;
        }
        #time-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px; background: #ff4757;
            border-radius: 50%; border: 3px solid #fff;
        }
        #info {
            position: absolute; top: 30px; width: 100%; text-align: center;
            color: white; pointer-events: none;
        }
        .time-label { color: #ffd32a; font-size: 50px; font-weight: 900; margin: 0; text-shadow: 0 0 20px rgba(255,211,42,0.5); }
        #status { font-size: 16px; color: #00ffcc; margin-top: 10px; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; display: inline-block; }
    </style>
</head>
<body>

<div id="info">
    <h1 style="font-size: 18px; letter-spacing: 10px; opacity: 0.8;">自擊漏 : THE WATER CLOCK</h1>
    <p id="time-label" class="time-label">06:00</p>
    <div id="status">태양의 고도에 따라 자격루가 가동됩니다.</div>
</div>

<div id="ui-container">
    <span style="color:white; margin-bottom:15px; font-weight:bold;">滿</span>
    <input type="range" id="time-slider" min="0" max="1000" value="0">
    <span style="color:white; margin-top:15px; font-weight:bold;">空</span>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // 1. Scene & Lighting
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(28, 18, 35);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // 태양 및 조명
    const sunGeom = new THREE.SphereGeometry(2, 32, 32);
    const sunMat = new THREE.MeshBasicMaterial({ color: 0xffea00 });
    const sun = new THREE.Mesh(sunGeom, sunMat);
    scene.add(sun);

    const sunLight = new THREE.DirectionalLight(0xffffff, 3);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.set(2048, 2048);
    scene.add(sunLight);
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));

    // 2. Materials
    const matRedWood = new THREE.MeshStandardMaterial({ color: '#5d1010', roughness: 0.2, metalness: 0.1 });
    const matBronze = new THREE.MeshStandardMaterial({ color: '#8e6d3e', metalness: 0.8, roughness: 0.4 });
    const matWater = new THREE.MeshStandardMaterial({ color: '#2980b9', transparent: true, opacity: 0.7 });
    const matGold = new THREE.MeshStandardMaterial({ color: '#d4af37', metalness: 1, roughness: 0.1 });

    // 3. 자격루 가구 및 기계 장치
    const jagyeongnu = new THREE.Group();

    // 3-1. 누기 (붉은 나무 받침대)
    const createBase = (w, h, d, x, y, z) => {
        const box = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), matRedWood);
        box.position.set(x, y + h/2, z);
        box.castShadow = true; box.receiveShadow = true;
        jagyeongnu.add(box);
    };
    createBase(25, 1, 12, 0, 0, 0);   // 지면 기단
    createBase(6, 11, 6, -8, 1, 0);  // 파수호 받침
    createBase(10, 14, 8, 6, 1, 0);  // 시보 인형실 및 방목 지지대

    // 3-2. 파수호(공급) & 수수호(저장)
    const pasuho = new THREE.Mesh(new THREE.CylinderGeometry(2, 2.3, 4, 32), matBronze);
    pasuho.position.set(-8, 14, 0);
    jagyeongnu.add(pasuho);

    const susuho = new THREE.Mesh(new THREE.CylinderGeometry(1.8, 1.8, 8, 32), matBronze);
    susuho.position.set(-2, 5, 0);
    jagyeongnu.add(susuho);

    const water = new THREE.Mesh(new THREE.CylinderGeometry(1.7, 1.7, 8, 32), matWater);
    water.position.copy(susuho.position);
    water.scale.y = 0.01;
    jagyeongnu.add(water);

    // 3-3. 부표 & 잣대 (수직 이동)
    const buoyGroup = new THREE.Group();
    const buoy = new THREE.Mesh(new THREE.CylinderGeometry(1.4, 1.4, 0.6, 32), matRedWood);
    const rod = new THREE.Mesh(new THREE.BoxGeometry(0.3, 14, 0.3), matGold);
    rod.position.y = 7;
    buoyGroup.add(buoy, rod);
    buoyGroup.position.set(-2, 1, 0);
    jagyeongnu.add(buoyGroup);

    // 3-4. 쇠구슬 통로 (방목)
    const track = new THREE.Mesh(new THREE.BoxGeometry(14, 0.6, 1.2), matRedWood);
    track.position.set(4, 13, 0);
    track.rotation.z = -0.05; // 경사
    jagyeongnu.add(track);

    const ball = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), matGold);
    ball.position.set(-1.5, 13.6, 0);
    jagyeongnu.add(ball);

    // 3-5. 시보 인형 및 악기 (종)
    const dollGroup = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 2), new THREE.MeshStandardMaterial({color: '#1a5276'}));
    const arm = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.2, 0.2), new THREE.MeshStandardMaterial({color: '#1a5276'}));
    arm.position.set(0.6, 0.5, 0); arm.rotation.z = -Math.PI/4;
    const bell = new THREE.Mesh(new THREE.CylinderGeometry(1, 1.3, 2, 20), matBronze);
    bell.position.set(2, 0, 0);
    dollGroup.add(body, arm, bell);
    dollGroup.position.set(9, 15, 0);
    jagyeongnu.add(dollGroup);

    scene.add(jagyeongnu);

    // 4. 로직 제어
    const slider = document.getElementById('time-slider');
    const timeLabel = document.getElementById('time-label');
    const statusText = document.getElementById('status');
    let autoValue = 0;
    let isActing = false;

    function update(val) {
        const v = val / 1000;
        
        // 태양 궤적 (좌->우 포물선)
        const angle = Math.PI * v;
        sun.position.set(-45 * Math.cos(angle), 35 * Math.sin(angle), -20);
        sunLight.position.copy(sun.position);
        scene.background = new THREE.Color().setHSL(0.6, 0.4, Math.max(0.05, Math.sin(angle) * 0.4));

        // 수위 및 잣대 물리 연동
        water.scale.y = Math.max(0.01, v);
        water.position.y = 5 + (v * 8 / 2) - 4;
        buoyGroup.position.y = 1 + (v * 10);

        // 시간 표시
        const h = Math.floor(v * 24);
        timeLabel.innerText = `${h.toString().padStart(2, '0')}:00`;

        // 트리거 (잣대가 공을 건드림)
        if (v > 0.88 && !isActing) triggerSequence();
    }

    async function triggerSequence() {
        isActing = true;
        statusText.innerText = "잣대가 구슬을 밀어냈습니다! 시보 작동 중...";
        
        // 1. 구슬 구르기 애니메이션
        const startX = ball.position.x;
        for(let i=0; i<60; i++) {
            ball.position.x += 0.18;
            ball.position.y -= 0.01;
            camera.lookAt(ball.position);
            await new Promise(r => setTimeout(r, 20));
        }

        // 2. 인형 타종 동작
        dollGroup.rotation.y = -0.3;
        statusText.innerText = "징~~! 시간이 기록되었습니다.";
        await new Promise(r => setTimeout(r, 1000));
        dollGroup.rotation.y = 0;

        // 3. 리셋
        setTimeout(() => {
            autoValue = 0;
            ball.position.set(-1.5, 13.6, 0);
            statusText.innerText = "태양의 고도에 따라 자격루가 가동됩니다.";
            isActing = false;
        }, 2000);
    }

    slider.addEventListener('input', (e) => { autoValue = parseInt(e.target.value); });

    function animate() {
        requestAnimationFrame(animate);
        if(!isActing) {
            autoValue = (autoValue + 0.5) % 1000;
            slider.value = autoValue;
        }
        update(autoValue);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>
