<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>자격루: 시간과 중력의 조화</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Pretendard', sans-serif; }
        
        /* 세로 슬라이더 레이아웃 */
        #ui-container {
            position: absolute; left: 40px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; align-items: center; z-index: 100;
        }
        #time-slider {
            -webkit-appearance: none; width: 8px; height: 400px; background: #222;
            outline: none; border-radius: 4px; writing-mode: bt-lr; /* 세로 방향 */
            appearance: slider-vertical; cursor: pointer;
        }
        #time-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; background: #ff4757;
            border-radius: 50%; cursor: pointer; border: 2px solid #fff;
        }

        #info {
            position: absolute; top: 30px; width: 100%; text-align: center;
            color: white; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        .time-label { color: #ffd32a; font-size: 40px; font-weight: 800; margin: 0; }
        #status { font-size: 14px; opacity: 0.8; margin-top: 5px; color: #00ffcc; }
    </style>
</head>
<body>

<div id="info">
    <h1 style="font-size: 20px; letter-spacing: 5px; margin-bottom: 5px;">自擊漏 : AUTOMATIC TIMEKEEPER</h1>
    <p id="time-label" class="time-label">06:00</p>
    <p id="status">태양의 궤적에 따라 물이 자동으로 차오릅니다.</p>
</div>

<div id="ui-container">
    <span style="color:white; margin-bottom:10px; font-size:12px;">滿 (FULL)</span>
    <input type="range" id="time-slider" min="0" max="1000" value="0">
    <span style="color:white; margin-top:10px; font-size:12px;">空 (EMPTY)</span>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // 1. 기본 설정
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(25, 15, 30);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    
    // 2. 태양 (동적 조명)
    const sunGeometry = new THREE.SphereGeometry(1.5, 32, 32);
    const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffdd00 });
    const sunSphere = new THREE.Mesh(sunGeometry, sunMaterial);
    scene.add(sunSphere);

    const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.set(2048, 2048);
    scene.add(sunLight);
    scene.add(new THREE.AmbientLight(0xffffff, 0.2));

    // 3. 자격루 본체와 쇠구슬 통로(방목)
    const matWood = new THREE.MeshStandardMaterial({ color: '#4a0e0e', roughness: 0.3 });
    const matBronze = new THREE.MeshStandardMaterial({ color: '#8e6d3e', metalness: 0.8 });
    const matGold = new THREE.MeshStandardMaterial({ color: '#f1c40f', metalness: 1 });

    const group = new THREE.Group();
    
    // 하단 지지대
    const base = new THREE.Mesh(new THREE.BoxGeometry(25, 1, 12), matWood);
    base.receiveShadow = true;
    group.add(base);

    // 수수호 (물을 받는 통)
    const susuho = new THREE.Mesh(new THREE.CylinderGeometry(2, 2.2, 8, 32), matBronze);
    susuho.position.set(-5, 4.5, 0);
    group.add(susuho);

    const water = new THREE.Mesh(new THREE.CylinderGeometry(1.9, 1.9, 8, 32), new THREE.MeshStandardMaterial({color: '#0984e3', transparent:true, opacity:0.7}));
    water.position.copy(susuho.position);
    water.scale.y = 0.01;
    group.add(water);

    // [중요] 쇠구슬 통로 객체 (방목) - 수수호에서 시보 인형까지 연결
    const track = new THREE.Mesh(new THREE.BoxGeometry(15, 0.5, 1), matWood);
    track.position.set(3, 9, 0);
    track.rotation.z = -0.05; // 구슬이 구르도록 살짝 기울임
    group.add(track);

    const trackWallL = new THREE.Mesh(new THREE.BoxGeometry(15, 0.3, 0.1), matWood);
    trackWallL.position.set(3, 9.3, 0.4);
    group.add(trackWallL);

    const trackWallR = trackWallL.clone();
    trackWallR.position.z = -0.4;
    group.add(trackWallR);

    // 부표와 잣대
    const buoyGroup = new THREE.Group();
    const buoy = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 0.5, 32), matWood);
    const rod = new THREE.Mesh(new THREE.BoxGeometry(0.3, 12, 0.3), matGold);
    rod.position.y = 6;
    buoyGroup.add(buoy, rod);
    buoyGroup.position.set(-5, 1, 0);
    group.add(buoyGroup);

    // 쇠구슬
    const ball = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), matGold);
    ball.position.set(-4, 9.5, 0);
    group.add(ball);

    scene.add(group);

    // 4. 자동화 제어 로직
    const slider = document.getElementById('time-slider');
    const timeLabel = document.getElementById('time-label');
    const status = document.getElementById('status');
    
    let autoValue = 0;
    let isPaused = false;

    function updateSim(val) {
        const v = val / 1000;
        
        // A. 태양 위치 조정 (왼쪽 -> 오른쪽 포물선)
        const angle = Math.PI * v; // 0 to PI
        const sunX = -40 * Math.cos(angle);
        const sunY = 30 * Math.sin(angle);
        sunSphere.position.set(sunX, sunY, -15);
        sunLight.position.copy(sunSphere.position);
        
        // 배경색 변화 (시간에 따른 하늘색)
        scene.background = new THREE.Color().setHSL(0.6, 0.5, Math.max(0.05, Math.sin(angle) * 0.4));

        // B. 물 수위 및 부표 상승
        water.scale.y = Math.max(0.01, v);
        water.position.y = 4.5 + (v * 8 / 2) - 4;
        buoyGroup.position.y = 1 + (v * 8);

        // C. 시간 텍스트 업데이트
        const hours = Math.floor(v * 24);
        timeLabel.innerText = `${hours.toString().padStart(2, '0')}:00`;

        // D. 구슬 발사 트리거 (잣대가 구슬을 건드림)
        if (v > 0.85 && !isPaused) {
            triggerBall();
        }
    }

    function triggerBall() {
        isPaused = true;
        status.innerText = "상태: 잣대가 구슬을 밀어냈습니다! 시보 작동!";
        
        let velocity = 0;
        const interval = setInterval(() => {
            velocity += 0.01;
            ball.position.x += velocity;
            camera.lookAt(ball.position);

            if (ball.position.x > 10) {
                clearInterval(interval);
                status.innerText = "상태: 징~ 시보 완료. 시스템 리셋.";
                setTimeout(() => {
                    autoValue = 0;
                    ball.position.set(-4, 9.5, 0);
                    isPaused = false;
                }, 2000);
            }
        }, 20);
    }

    // 슬라이더 직접 조정 시
    slider.addEventListener('input', (e) => {
        autoValue = parseInt(e.target.value);
    });

    // 5. 애니메이션 루프
    function animate() {
        requestAnimationFrame(animate);
        
        if (!isPaused) {
            autoValue = (autoValue + 1) % 1000; // 자동으로 조금씩 채워짐
            slider.value = autoValue;
        }
        
        updateSim(autoValue);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
