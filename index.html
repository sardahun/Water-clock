<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>조선의 AI, 자격루 3D 시뮬레이션</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: 'Pretendard', sans-serif; }
        #ui-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 80%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px);
            padding: 20px; border-radius: 50px; display: flex; align-items: center; gap: 20px;
            border: 1px solid rgba(255,255,255,0.2); z-index: 100;
        }
        #time-slider { flex-grow: 1; accent-color: #e67e22; }
        .label { color: #ddd; font-size: 14px; font-weight: bold; min-width: 50px; }
        #info { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); z-index: 100; }
        #current-time { font-size: 32px; font-weight: 800; color: #fee140; margin-top: 5px; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="info">
    <div style="color: #e67e22; font-weight: bold; letter-spacing: 2px;">JAGEOKRU SIMULATION</div>
    <h1>국보 제229호 자격루</h1>
    <div id="current-time">12:00</div>
</div>

<div id="ui-panel">
    <span class="label">묘시(晨)</span>
    <input type="range" id="time-slider" min="0" max="1440" value="720">
    <span class="label">인시(夜)</span>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // 1. 기본 세팅
    const scene = new THREE.Scene();
    scene.background = new THREE.Color('#34495e');
    scene.fog = new THREE.FogExp2('#34495e', 0.015); // 배경 블러 효과

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(15, 12, 20);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.toneMapping = THREE.ReinhardToneMapping;
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // 2. 조명 (태양)
    const sunLight = new THREE.DirectionalLight(0xffffff, 2);
    sunLight.castShadow = true;
    scene.add(sunLight);
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));

    // 3. 조선 시대 배경 (마을 형상화)
    function createVillage() {
        const village = new THREE.Group();
        const houseGeo = new THREE.BoxGeometry(2, 1, 1.5);
        const roofGeo = new THREE.ConeGeometry(1.5, 1, 4);
        const houseMat = new THREE.MeshStandardMaterial({ color: '#d1ccc0' });
        const roofMat = new THREE.MeshStandardMaterial({ color: '#2c3e50' });

        for(let i=0; i<30; i++) {
            const h = new THREE.Mesh(houseGeo, houseMat);
            const r = new THREE.Mesh(roofGeo, roofMat);
            const x = (Math.random() - 0.5) * 80;
            const z = (Math.random() - 0.5) * 80;
            if (Math.abs(x) < 15 && Math.abs(z) < 15) continue; // 자격루 주변 비우기
            h.position.set(x, 0.5, z);
            r.position.set(x, 1.5, z);
            r.rotation.y = Math.PI / 4;
            village.add(h, r);
        }
        scene.add(village);
    }
    createVillage();

    // 4. 자격루 본체 (디테일 업)
    const jagyeongnu = new THREE.Group();
    
    // 재질 (포스터 물감 스타일 고채도)
    const matBronze = new THREE.MeshStandardMaterial({ color: '#cd7f32', metalness: 0.8, roughness: 0.2 }); // 청동 항아리
    const matDeepGreen = new THREE.MeshStandardMaterial({ color: '#16a085', roughness: 0.5 });
    const matRedWood = new THREE.MeshStandardMaterial({ color: '#c0392b' }); // 화려한 붉은 나무 기둥
    const matGold = new THREE.MeshStandardMaterial({ color: '#f1c40f', metalness: 1, roughness: 0.1 });

    // 파수호(항아리) 3개 세트
    const pots = [
        { r: 2, h: 3, y: 8, x: -4 },
        { r: 1.5, h: 2.5, y: 5, x: -2 },
        { r: 1.2, h: 2, y: 2, x: 0 }
    ];
    pots.forEach(p => {
        const mesh = new THREE.Mesh(new THREE.CylinderGeometry(p.r, p.r*1.1, p.h, 32), matBronze);
        mesh.position.set(p.x, p.y, 0);
        jagyeongnu.add(mesh);
    });

    // 수수호 (긴 사각형 통)
    const susuho = new THREE.Mesh(new THREE.BoxGeometry(2, 6, 2), matBronze);
    susuho.position.set(3, 3, 0);
    jagyeongnu.add(susuho);

    // 시보 장치 (종, 북, 징)
    const createInstrument = (type, x, y, z, color) => {
        const group = new THREE.Group();
        const frame = new THREE.Mesh(new THREE.BoxGeometry(0.2, 5, 0.2), matRedWood);
        const top = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 0.2), matRedWood);
        frame.position.set(0, 2.5, 0);
        top.position.set(0, 5, 0);
        
        let target;
        if(type === '종') target = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.8, 1.2, 20), new THREE.MeshStandardMaterial({color: color, metalness: 0.9}));
        if(type === '북') target = new THREE.Mesh(new THREE.CylinderGeometry(0.7, 0.7, 1.5, 20), new THREE.MeshStandardMaterial({color: color}));
        if(type === '징') target = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.1, 32), new THREE.MeshStandardMaterial({color: color, metalness: 1}));
        
        target.position.set(0, 3.5, 0);
        if(type === '북') target.rotation.z = Math.PI/2;
        
        group.add(frame, top, target);
        group.position.set(x, y, z);
        return { group, target };
    };

    const bell = createInstrument('종', 7, 0, -2, '#f1c40f'); // 종 (시)
    const drum = createInstrument('북', 7, 0, 0, '#e67e22');  // 북 (경)
    const gong = createInstrument('징', 7, 0, 2, '#d35400');  // 징 (점)
    jagyeongnu.add(bell.group, drum.group, gong.group);

    // 쇠구슬 (주전)
    const ball = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), matGold);
    ball.position.set(4, 5, 0);
    jagyeongnu.add(ball);

    scene.add(jagyeongnu);

    // 바닥
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({color: '#27ae60'}));
    ground.rotation.x = -Math.PI/2;
    ground.position.y = 0;
    ground.receiveShadow = true;
    scene.add(ground);

    // 5. 애니메이션 및 인터랙션
    const slider = document.getElementById('time-slider');
    const timeDisplay = document.getElementById('current-time');

    slider.addEventListener('input', (e) => {
        const val = e.target.value;
        const h = Math.floor(val / 60);
        const m = val % 60;
        timeDisplay.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;

        // 태양 위치 조절
        const angle = (val / 1440) * Math.PI * 2 - Math.PI/2;
        sunLight.position.set(Math.cos(angle)*20, Math.sin(angle)*20, 10);
        
        // 시간별 배경색 변화 (포스터 스타일)
        const skyHue = Math.sin(angle) * 0.5 + 0.5;
        scene.background.setHSL(0.6, 0.4, skyHue * 0.5);
        scene.fog.color.copy(scene.background);

        // 정시(Bell), 2시간(Drum), 15분(Gong) 이벤트 트리거 예시
        if(m === 0) triggerSequence(bell.target, '종!!');
    });

    function triggerSequence(target, msg) {
        // 1. 카메라 쇠구슬 시점
        const originalPos = camera.position.clone();
        const ballPos = ball.position.clone().add(new THREE.Vector3(2, 1, 2));
        
        // 단순 카메라 워킹 시뮬레이션 (실제 구현 시 GSAP 권장)
        camera.position.lerp(ballPos, 0.5);
        setTimeout(() => {
            camera.position.lerp(originalPos, 0.1);
            console.log(msg);
        }, 1000);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
