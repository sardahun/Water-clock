<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>조선의 정밀 자동시계: 자격루</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0a0a0a; font-family: 'Noto Sans KR', sans-serif; }
        
        /* 커스텀 슬라이더 UI */
        #ui-layer {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 70%; z-index: 100; text-align: center;
        }
        #time-slider {
            width: 100%; height: 10px; border-radius: 5px; background: #333;
            outline: none; -webkit-appearance: none; cursor: pointer;
        }
        #time-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 25px; height: 25px; 
            background: #ff4d4d; border: 3px solid #fff; border-radius: 50%;
        }
        
        #info-box {
            position: absolute; top: 30px; left: 40px; color: #fff; z-index: 10;
            border-left: 4px solid #ff4d4d; padding-left: 20px;
        }
        h1 { margin: 0; font-size: 28px; letter-spacing: 2px; color: #f1c40f; }
        #time-readout { font-size: 48px; font-weight: 900; margin: 5px 0; color: #fff; }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; box-shadow: inset 0 0 150px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

<div id="overlay"></div>
<div id="info-box">
    <h1>自擊漏 JAGEOKRU</h1>
    <div id="time-readout">06:00</div>
    <p style="opacity: 0.7;">슬라이더를 움직여 수위를 조절하면 시보가 시작됩니다.</p>
</div>

<div id="ui-layer">
    <input type="range" id="time-slider" min="0" max="1000" value="0">
    <div style="display:flex; justify-content: space-between; color:#fff; margin-top:10px; font-size:12px; opacity:0.5;">
        <span>낮 (DAY)</span><span>밤 (NIGHT)</span>
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // 1. 초기화
    const scene = new THREE.Scene();
    scene.background = new THREE.Color('#111');
    scene.fog = new THREE.FogExp2('#111', 0.02);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(22, 15, 28);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // 조명 (고대비 드라마틱 라이팅)
    const sun = new THREE.DirectionalLight(0xffffff, 3);
    sun.position.set(15, 30, 20);
    sun.castShadow = true;
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0xffffff, 0.3));

    // 2. 재질 (현실감 있는 텍스처 느낌)
    const matLacquer = new THREE.MeshStandardMaterial({ color: '#4a0e0e', roughness: 0.2, metalness: 0.1 }); // 붉은 옻칠 나무
    const matBronze = new THREE.MeshStandardMaterial({ color: '#8e6d3e', metalness: 0.8, roughness: 0.4 }); // 청동
    const matWater = new THREE.MeshStandardMaterial({ color: '#2980b9', transparent: true, opacity: 0.8 });
    const matGold = new THREE.MeshStandardMaterial({ color: '#f1c40f', metalness: 1, roughness: 0.2 });

    // 3. 자격루 가구 구조 (누기)
    const mainGroup = new THREE.Group();
    
    // 계단식 지지대
    const createPart = (w, h, d, x, y, z) => {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), matLacquer);
        mesh.position.set(x, y + h/2, z);
        mesh.castShadow = true; mesh.receiveShadow = true;
        mainGroup.add(mesh);
    };
    createPart(20, 1, 10, 0, 0, 0);   // 하단 기단
    createPart(5, 10, 5, -7, 1, 0);  // 대파구 받침
    createPart(5, 7, 5, -1, 1, 0);   // 중/소파구 받침
    createPart(8, 14, 8, 7, 1, 0);   // 주전 및 시보실 상자

    // 4. 항아리 & 물줄기 시각화
    const pots = [];
    const createPot = (r, h, x, y, z) => {
        const pot = new THREE.Mesh(new THREE.CylinderGeometry(r, r*1.2, h, 32), matBronze);
        pot.position.set(x, y + h/2, z);
        mainGroup.add(pot);
        
        const water = new THREE.Mesh(new THREE.CylinderGeometry(r*0.9, r*0.9, h, 32), matWater);
        water.position.copy(pot.position);
        water.scale.y = 0.01;
        mainGroup.add(water);
        return { water, h, basePos: pot.position.y };
    };

    const pot1 = createPot(2, 4, -7, 11, 0); // 대파구
    const pot2 = createPot(1.5, 3, -1, 8, 0); // 수수호
    
    // 부표 & 잣대 (실제 물 위로 뜨는 장치)
    const buoyGroup = new THREE.Group();
    const buoy = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 0.5, 32), matLacquer);
    const rod = new THREE.Mesh(new THREE.BoxGeometry(0.3, 12, 0.3), matGold);
    rod.position.y = 6;
    buoyGroup.add(buoy, rod);
    buoyGroup.position.set(-1, 8.5, 0);
    mainGroup.add(buoyGroup);

    // 5. 시보 인형 3남 (종, 북, 징)
    const dolls = [];
    const names = ['종', '북', '징'];
    names.forEach((name, i) => {
        const dGroup = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 1.8), new THREE.MeshStandardMaterial({color: '#1a5276'}));
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.7, 0.7), new THREE.MeshStandardMaterial({color: '#000'}));
        head.position.y = 1.3;
        
        let inst;
        if(name === '종') inst = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.8, 1.4, 20), matBronze);
        if(name === '북') inst = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 1.5, 20), new THREE.MeshStandardMaterial({color: '#ba4a00'}));
        if(name === '징') inst = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 0.15, 32), matBronze);
        inst.position.set(1.5, 1, 0);
        if(name === '북') inst.rotation.z = Math.PI/2;

        dGroup.add(body, head, inst);
        dGroup.position.set(5, 15, (i-1)*3);
        mainGroup.add(dGroup);
        dolls.push({ group: dGroup, name });
    });

    // 쇠구슬
    const ball = new THREE.Mesh(new THREE.SphereGeometry(0.25, 24, 24), matGold);
    ball.position.set(-0.5, 15, 0);
    mainGroup.add(ball);

    scene.add(mainGroup);

    // 6. 물줄기 입자 효과 (단순화된 입자)
    const particleGeo = new THREE.SphereGeometry(0.05, 4, 4);
    const particles = [];
    for(let i=0; i<20; i++) {
        const p = new THREE.Mesh(particleGeo, matWater);
        p.visible = false;
        scene.add(p);
        particles.push(p);
    }

    // 7. 슬라이더 이벤트 및 로직
    const slider = document.getElementById('time-slider');
    const readout = document.getElementById('time-readout');
    let isPlaying = false;

    slider.addEventListener('input', (e) => {
        const v = e.target.value / 1000;
        
        // 1. 수수호 물 채우기
        pot2.water.scale.y = v;
        pot2.water.position.y = pot2.basePos + (v * pot2.h / 2) - pot2.h/2;
        
        // 2. 부표 물리 연동 상승
        buoyGroup.position.y = 8.5 + (v * pot2.h);
        
        // 3. 시간 표시
        const h = Math.floor(v * 24);
        readout.innerText = `${h.toString().padStart(2, '0')}:00`;

        // 4. 임계점 도달 시 쇠구슬 시퀀스
        if(v > 0.85 && !isPlaying) triggerAlarm();
    });

    async function triggerAlarm() {
        isPlaying = true;
        // 카메라 구슬 시점 전환
        const ballTarget = ball.position.clone().add(new THREE.Vector3(5, 2, 5));
        
        // 구슬 굴러가기
        for(let i=0; i<40; i++) {
            ball.position.x += 0.2;
            camera.lookAt(ball.position);
            await new Promise(r => setTimeout(r, 20));
        }

        // 인형 애니메이션
        dolls[0].group.rotation.y = 0.5;
        await new Promise(r => setTimeout(r, 500));
        dolls[0].group.rotation.y = 0;

        setTimeout(() => {
            ball.position.set(-0.5, 15, 0);
            isPlaying = false;
        }, 2000);
    }

    // 8. 애니메이션 루프
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        
        // 물 떨어지는 효과 애니메이션
        particles.forEach((p, i) => {
            if(!p.visible) {
                p.visible = true;
                p.position.set(-5, 14, 0);
            }
            p.position.y -= 0.1;
            p.position.x += 0.04;
            if(p.position.y < 10) p.visible = false;
        });

        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>
